services:
  # Preprocessing service
  preprocess:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdm_preprocess
    volumes:
      - ./src:/app/src:ro
      - ./data/raw:/app/data/raw:ro
      - ./data/processed:/app/data/processed:rw
    environment:
      - PYTHONPATH=/app
    working_dir: /app
    command: ["python", "-m", "src.preprocessing.data_merger"]

  # Algorithm runner service
  algorithms:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdm_algorithms
    volumes:
      - ./src:/app/src:ro
      - ./data/processed:/app/data/processed:ro
      - ./results:/app/results:rw
    environment:
      - PYTHONPATH=/app
    working_dir: /app
    command: ["python", "-m", "src.algorithms.algorithm_runner", "--all", "--parallel", "--workers", "4"]

  # Stability analysis service
  analysis:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdm_analysis
    volumes:
      - ./src:/app/src:ro
      - ./results:/app/results:rw
    environment:
      - PYTHONPATH=/app
    working_dir: /app
    command: ["python", "-m", "src.analysis.stability_calculator"]

  # Visualization service (algorithm results only)
  visualize:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdm_visualize
    volumes:
      - ./src:/app/src:ro
      - ./results:/app/results:rw
    environment:
      - PYTHONPATH=/app
    working_dir: /app
    command: ["python", "-m", "src.visualization.plot_results"]

  # Full visualization service (includes dataset figures)
  visualize-all:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdm_visualize_all
    volumes:
      - ./src:/app/src:ro
      - ./data/raw:/app/data/raw:ro
      - ./data/processed:/app/data/processed:ro
      - ./results:/app/results:rw
      - ./generate_dataset_figures.py:/app/generate_dataset_figures.py:ro
    environment:
      - PYTHONPATH=/app
    working_dir: /app
    command: ["python", "-m", "src.visualization.plot_results", "--include-dataset"]

  # Dataset figures only
  dataset-figures:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdm_dataset_figures
    volumes:
      - ./data/raw:/app/data/raw:ro
      - ./data/processed:/app/data/processed:ro
      - ./results:/app/results:rw
      - ./generate_dataset_figures.py:/app/generate_dataset_figures.py:ro
    environment:
      - PYTHONPATH=/app
    working_dir: /app
    command: ["python", "generate_dataset_figures.py"]

  # Paper figures (publication quality)
  paper-figures:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdm_paper_figures
    volumes:
      - ./results:/app/results:ro
      - ./paper_figures:/app/paper_figures:rw
      - ./generate_paper_figures.py:/app/generate_paper_figures.py:ro
      - ./generate_extra_figures.py:/app/generate_extra_figures.py:ro
    environment:
      - PYTHONPATH=/app
    working_dir: /app
    command: >
      sh -c "python generate_paper_figures.py && python generate_extra_figures.py"

# Network configuration
networks:
  default:
    name: pdm_network
